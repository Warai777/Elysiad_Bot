<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elysiad Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Mobile viewport height fix (in head or top of body is fine) -->
    <script>
      function setVh() {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      window.addEventListener('resize', setVh);
      window.addEventListener('orientationchange', setVh);
      setVh();
    </script>
</head>
<body>
    <!-- MOBILE NAV ONLY (hidden on desktop) -->
    <nav class="mobile-nav">
        <div class="nav-hamburger" id="hamburger">&#9776;</div>
        <div class="nav-title">Elysiad</div>
        <button class="nav-logout" onclick="location.href='{{ url_for('logout') }}'">Logout</button>
    </nav>
    <div class="sidebar-drawer" id="sidebarDrawer">
        <a href="#" id="closeSidebar">&times;</a>
        <a href="#" id="showGlobalEvent">Global Event</a>
        <a href="{{ url_for('char_sheet', username=current_user.username) }}">Character</a>
        <a href="{{ url_for('lore_index') }}">Lore</a>
    </div>
    <div class="modal" id="globalEventModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div class="global-event-box">
                <strong>Global Event</strong><br>
                <div class="event-content">{{ global_event or 'No global event at the moment.' }}</div>
                <div class="event-timer"><b>Next event in:</b> <span id="global-timer"></span></div>
            </div>
        </div>
    </div>
    <!-- DESKTOP NAV AND LAYOUT -->
    <div class="top-bar">
        <div class="logo">Elysiad</div>
        <div>
            <a href="{{ url_for('logout') }}" class="signup-btn logout">Logout</a>
        </div>
    </div>
    <!-- Story Panel (centered, takes up all available space) -->
    <div class="story-fullscreen-panel">
        <div class="story-main-box">
            <div class="story-main-title">Story</div>
            <div class="story-content-scroll" id="story-box">
                {% for item in history %}
                    {{ item|safe }}<br>
                {% endfor %}
            </div>
            <div id="button-zone">
                {% if not user["Story"]["started"] %}
                    <form id="begin-form" class="begin-adventure-form">
                        <input type="hidden" name="begin" value="1">
                        <button type="submit" class="begin-btn">Begin Adventure</button>
                    </form>
                {% else %}
                    <form id="choice-form" class="choices-form">
                        <input type="number" name="choice" min="1" max="5" placeholder="Choice #" required>
                        <button type="submit">Choose</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    <img src="{{ url_for('static', filename='elysiad-mascot.png') }}" class="mascot" alt="mascot">
        <!-- JS -->
    <script>
    // Mobile nav logic
    document.addEventListener('DOMContentLoaded', function() {
        var hamburger = document.getElementById('hamburger');
        var sidebar = document.getElementById('sidebarDrawer');
        var closeSidebar = document.getElementById('closeSidebar');
        var showGlobalEvent = document.getElementById('showGlobalEvent');
        var globalModal = document.getElementById('globalEventModal');
        var closeModal = document.getElementById('closeModal');

        if (hamburger && sidebar) {
            hamburger.onclick = function() { sidebar.classList.add('open'); };
            closeSidebar.onclick = function() { sidebar.classList.remove('open'); };
        }
        if (showGlobalEvent && globalModal && closeModal) {
            showGlobalEvent.onclick = function(e) {
                e.preventDefault();
                sidebar.classList.remove('open');
                globalModal.style.display = "block";
            };
            closeModal.onclick = function() { globalModal.style.display = "none"; };
            globalModal.onclick = function(e) { if(e.target === globalModal) globalModal.style.display = "none"; };
        }
    });

    // Global Event Timer
    (function() {
        const nextEventTs = {{ next_event_ts|tojson }};
        function pad(n){ return n < 10 ? '0'+n : n; }
        function updateTimer() {
            const now = Math.floor(Date.now()/1000);
            let diff = nextEventTs - now;
            if (diff < 0) diff = 0;
            let hours = Math.floor(diff/3600);
            let minutes = Math.floor((diff % 3600)/60);
            let seconds = diff % 60;
            var timerElems = document.querySelectorAll('#global-timer');
            for(let t of timerElems)
                t.textContent = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
        }
        updateTimer();
        setInterval(updateTimer, 1000);
    })();

    // Typewriter Streaming (unchanged)
    function streamTypewriterAppend(element, stream) {
        const reader = stream.getReader();
        let text = "";
        let appendDiv = document.createElement("div");
        appendDiv.className = "new-chapter";
        element.appendChild(appendDiv);

        function read() {
            reader.read().then(({done, value}) => {
                if (done) {
                    element.scrollTop = element.scrollHeight;
                    return;
                }
                const chunk = new TextDecoder().decode(value);
                text += chunk;
                appendDiv.innerHTML = text;
                element.scrollTop = element.scrollHeight;
                read();
            });
        }
        read();
    }

    function attachBeginListener() {
        const beginForm = document.getElementById('begin-form');
        if (beginForm) {
            beginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const box = document.getElementById('story-box');
                box.innerHTML = ""; // Start fresh!
                document.getElementById('button-zone').innerHTML = `
                    <form id="choice-form" class="choices-form">
                        <input type="number" name="choice" min="1" max="5" placeholder="Choice #" required>
                        <button type="submit">Choose</button>
                    </form>
                `;
                attachChoiceListener();
                fetch('/stream_story', {
                    method: 'POST',
                    body: new FormData(beginForm),
                }).then(response => {
                    streamTypewriterAppend(box, response.body);
                });
            });
        }
    }

    function attachChoiceListener() {
        const form = document.getElementById('choice-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const box = document.getElementById('story-box');
                fetch('/stream_story', {
                    method: 'POST',
                    body: new FormData(form),
                }).then(response => {
                    streamTypewriterAppend(box, response.body);
                });
            });
        }
    }

    attachBeginListener();
    attachChoiceListener();

    // --- Mobile Keyboard Resize Fix ---
    // Ensure story scroll area remains visible when the keyboard closes/opens
    window.addEventListener('resize', function() {
        // Use the updated --vh variable for sizing, if using in your CSS
        setTimeout(function() {
            const storyBox = document.getElementById('story-box');
            if(storyBox) {
                storyBox.scrollTop = storyBox.scrollHeight;
            }
        }, 350); // Delay helps after the keyboard animation finishes
    });
    </script>
</body>
</html>

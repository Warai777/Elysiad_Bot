<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elysiad Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="top-bar">
        <div class="logo">Elysiad</div>
        <div>
            <a href="{{ url_for('char_sheet', username=current_user.username) }}" class="signup-btn">Character</a>
            <a href="{{ url_for('lore_index') }}" class="signup-btn">Lore</a>
            <a href="{{ url_for('logout') }}" class="signup-btn logout">Logout</a>
        </div>
    </div>
    <div class="dashboard-flex">
        <aside class="global-event-container">
            <div class="global-event-box">
                <strong>Global Event</strong><br>
                <div class="event-content">{{ global_event or 'No global event at the moment.' }}</div>
                <div class="event-timer">
                    <b>Next event in:</b> <span id="global-timer"></span>
                </div>
            </div>
        </aside>
        <main class="story-center-panel">
            <div class="story-main-box">
                <div class="story-main-title">Story</div>
                <div class="story-content-scroll" id="story-box">
                    {% for item in history %}
                        {{ item|safe }}<br>
                    {% endfor %}
                </div>
                <div id="button-zone">
                    {% if not user["Story"]["started"] %}
                        <form id="begin-form" class="begin-adventure-form">
                            <input type="hidden" name="begin" value="1">
                            <button type="submit" class="begin-btn">Begin Adventure</button>
                        </form>
                    {% else %}
                        <form id="choice-form" class="choices-form">
                            <input type="number" name="choice" min="1" max="5" placeholder="Choice #" required>
                            <button type="submit">Choose</button>
                        </form>
                    {% endif %}
                </div>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul class="flashes">
                        {% for category, msg in messages %}
                            <li class="flash-{{ category }}">{{ msg }}</li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}
            </div>
        </main>
        <aside class="char-sheet-container">
            <div class="char-sheet-box">
                <h3>Character Sheet</h3>
                <strong>Tier:</strong> {{ user.Tier }}<br>
                <strong>HP:</strong> {{ user.HP }}<br>
                <strong>Origin Essence:</strong> {{ user['Origin Essence'] }}<br>
                <strong>Inventory:</strong>
                <ul>
                    {% for item in user.Inventory %}
                        <li>{{ item }}</li>
                    {% else %}
                        <li>None</li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
    </div>
    <img src="{{ url_for('static', filename='elysiad-mascot.png') }}" class="mascot" alt="mascot">

    <!-- JS -->
    <script>
    // Global Event Timer (no change)
    (function() {
        const nextEventTs = {{ next_event_ts|tojson }};
        function pad(n){ return n < 10 ? '0'+n : n; }
        function updateTimer() {
            const now = Math.floor(Date.now()/1000);
            let diff = nextEventTs - now;
            if (diff < 0) diff = 0;
            let hours = Math.floor(diff/3600);
            let minutes = Math.floor((diff % 3600)/60);
            let seconds = diff % 60;
            document.getElementById('global-timer').textContent =
                pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
        }
        updateTimer();
        setInterval(updateTimer, 1000);
    })();

    // Typewriter Streaming
    function streamTypewriterAppend(element, stream) {
        const reader = stream.getReader();
        let text = "";
        // Add a separating line for clarity
        let appendDiv = document.createElement("div");
        appendDiv.className = "new-chapter";
        element.appendChild(appendDiv);

        function read() {
            reader.read().then(({done, value}) => {
                if (done) {
                    // After streaming, scroll to bottom
                    element.scrollTop = element.scrollHeight;
                    return;
                }
                const chunk = new TextDecoder().decode(value);
                text += chunk;
                appendDiv.innerHTML = text; // Typing effect could be made per-character, but streaming is already incremental.
                element.scrollTop = element.scrollHeight;
                read();
            });
        }
        read();
    }

    function attachBeginListener() {
        const beginForm = document.getElementById('begin-form');
        if (beginForm) {
            beginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const box = document.getElementById('story-box');
                box.innerHTML = ""; // Start fresh on new adventure!
                fetch('/stream_story', {
                    method: 'POST',
                    body: new FormData(beginForm),
                }).then(response => {
                    streamTypewriterAppend(box, response.body);
                    response.body.getReader().read().then(function process() {
                        document.getElementById('button-zone').innerHTML = `
                            <form id="choice-form" class="choices-form">
                                <input type="number" name="choice" min="1" max="5" placeholder="Choice #" required>
                                <button type="submit">Choose</button>
                            </form>
                        `;
                        attachChoiceListener();
                    });
                });
            });
        }
    }
    function attachChoiceListener() {
        const form = document.getElementById('choice-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const box = document.getElementById('story-box');
                // Instead of clearing, we **append** new chapter
                fetch('/stream_story', {
                    method: 'POST',
                    body: new FormData(form),
                }).then(response => {
                    streamTypewriterAppend(box, response.body);
                });
            });
        }
    }
    attachBeginListener();
    attachChoiceListener();
    </script>
    <style>
    /* Optional: visually separate chapters */
    .new-chapter {
        margin-top: 1.25em;
        padding-top: .5em;
        border-top: 1px solid #aaa;
        min-height: 1.5em;
    }
    .story-content-scroll {
        max-height: 45vh;
        overflow-y: auto;
        padding-right: 10px;
        font-family: 'Georgia', serif;
        font-size: 1.04em;
        background: #fafafc;
    }
    </style>
</body>
</html>

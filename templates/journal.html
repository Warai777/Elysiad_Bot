<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/journal_page_flip.css">
</head>
<body>
  <div class="tab-bar">
    <button class="tab-button" data-tab="hints">Hints</button>
    <button class="tab-button" data-tab="lore">Lore</button>
    <button class="tab-button" data-tab="notes">Notes</button>
  </div>

  <div class="journal-wrapper">
    <div class="book-frame"></div>
    <div class="pages-container" id="pagesContainer"></div>
  </div>

  <div class="button-container">
    <button class="flip-button" onclick="flipPrev()">Previous</button>
    <button class="flip-button" onclick="flipNext()">Next</button>
  </div>

  <input class="note-input" id="noteInput" type="text" placeholder="Write your note and press Enter..." onkeydown="handleNoteInput(event)" />

  <script>
    let currentTab = 'hints';
    let currentPageIndex = 0;
    let isWriting = false;

    const data = {
      hints: ["The Archivist awaits.", "Only fools touch the mirror."],
      lore: ["There was once a gate carved from shadow.", "The mark glows only in moonlight."],
      notes: []
    };

    const pagesContainer = document.getElementById('pagesContainer');
    const noteInput = document.getElementById('noteInput');

    function createPage(content, side, index) {
      const page = document.createElement('div');
      page.className = 'page ' + side + '-page';
      page.style.zIndex = 1000 - index;
      page.innerHTML = '<div class="page-content"></div>';
      animateText(page.querySelector('.page-content'), content);
      return page;
    }

    function animateText(el, text) {
      el.innerHTML = '';
      let i = 0;
      function type() {
        if (i < text.length) {
          el.innerHTML += text.charAt(i);
          i++;
          setTimeout(type, 20);
        } else {
          isWriting = false;
          noteInput.disabled = false;
        }
      }
      isWriting = true;
      noteInput.disabled = true;
      type();
    }

    function renderPages() {
      pagesContainer.innerHTML = '';
      const sectionData = data[currentTab];
      const leftContent = sectionData[currentPageIndex * 2] || '';
      const rightContent = sectionData[currentPageIndex * 2 + 1] || '';

      const leftPage = createPage(leftContent, 'left', currentPageIndex * 2);
      const rightPage = createPage(rightContent, 'right', currentPageIndex * 2 + 1);

      pagesContainer.appendChild(leftPage);
      pagesContainer.appendChild(rightPage);
    }

    function flipNext() {
      const sectionData = data[currentTab];
      if ((currentPageIndex + 1) * 2 < sectionData.length) {
        currentPageIndex++;
        renderPages();
      }
    }

    function flipPrev() {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        renderPages();
      }
    }

    function handleNoteInput(e) {
      if (e.key === 'Enter' && !isWriting) {
        const value = e.target.value.trim();
        if (value) {
          const chunks = value.match(/.{1,60}/g) || [value];
          chunks.forEach(chunk => data.notes.push(chunk));
          e.target.value = '';
          currentTab = 'notes';
          currentPageIndex = Math.floor((data.notes.length - 1) / 2);
          renderPages();
        }
      }
    }

    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTab = btn.dataset.tab;
        currentPageIndex = 0;
        renderPages();
        noteInput.style.display = currentTab === 'notes' ? 'block' : 'none';
      });
    });

    renderPages();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elysiad Journal</title>
  <link rel="stylesheet" href="/static/journal_page_flip.css" />
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&family=Homemade+Apple&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Tab Containers -->
  <div class="tab-container left" id="tabContainerLeft"></div>
  <div class="tab-container right" id="tabContainerRight"></div>

  <!-- Journal -->
  <div class="journal-wrapper">
    <div class="book-frame"></div>
    <div class="page-spread" id="pageSpread">
      <div class="page left-page" id="leftPage"></div>
      <div class="page right-page" id="rightPage"></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="button-container">
    <button class="flip-button" id="prevBtn">Previous</button>
    <button class="flip-button" id="nextBtn">Next</button>
  </div>

  <!-- Notes input -->
  <input type="text" class="note-input" id="noteInput" placeholder="Write your note and press Enter..." />

  <script>
    const sections = {
      hints: ["The Archivist awaits.", "Only fools touch the mirror."],
      lore: ["A coin flipped through dimensions.", "They return on lunar eclipses."],
      notes: []
    };

    let currentSection = 'hints';
    let currentPageIndex = 0;

    const leftPage = document.getElementById('leftPage');
    const rightPage = document.getElementById('rightPage');
    const noteInput = document.getElementById('noteInput');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const tabContainerLeft = document.getElementById('tabContainerLeft');
    const tabContainerRight = document.getElementById('tabContainerRight');

    function paginate(content, charsPerPage = 200) {
      const lines = [];
      let buffer = '';
      for (let item of content) {
        if ((buffer + item).length > charsPerPage) {
          lines.push(buffer.trim());
          buffer = '';
        }
        buffer += item + '\n';
      }
      if (buffer.trim()) lines.push(buffer.trim());
      return lines;
    }

    function renderPages() {
      const pages = paginate(sections[currentSection]);
      leftPage.textContent = pages[currentPageIndex] || '';
      rightPage.textContent = pages[currentPageIndex + 1] || '';
    }

    function createTab(name, side) {
      const tab = document.createElement('div');
      tab.className = 'tab flip-tab';
      tab.textContent = name.charAt(0).toUpperCase() + name.slice(1);
      tab.dataset.section = name;
      tab.addEventListener('click', () => {
        if (!tab.classList.contains('active')) {
          tab.classList.add('flipping');
          setTimeout(() => {
            switchSection(name);
            tab.classList.remove('flipping');
          }, 300);
        }
      });
      if (name === currentSection) tab.classList.add('active');
      (side === 'left' ? tabContainerLeft : tabContainerRight).appendChild(tab);
    }

    function renderTabs() {
      tabContainerLeft.innerHTML = '';
      tabContainerRight.innerHTML = '';

      if (currentSection === 'hints') {
        createTab('hints', 'left');
        createTab('lore', 'right');
        createTab('notes', 'right');
      } else if (currentSection === 'lore') {
        createTab('hints', 'left');
        createTab('lore', 'left');
        createTab('notes', 'right');
      } else {
        createTab('hints', 'left');
        createTab('lore', 'left');
        createTab('notes', 'left');
      }
    }

    function switchSection(section) {
      currentSection = section;
      currentPageIndex = 0;
      renderTabs();
      renderPages();
    }

    noteInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && currentSection === 'notes') {
        const value = noteInput.value.trim();
        if (value) {
          const chars = value.split('');
          let buffer = '';
          function animateWrite() {
            if (chars.length > 0) {
              buffer += chars.shift();
              sections.notes.push(buffer);
              renderPages();
              sections.notes.pop();
              requestAnimationFrame(animateWrite);
            } else {
              sections.notes.push(buffer);
              renderPages();
              noteInput.value = '';
            }
          }
          animateWrite();
        }
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentPageIndex - 2 >= 0) {
        currentPageIndex -= 2;
        renderPages();
      }
    });

    nextBtn.addEventListener('click', () => {
      const maxPages = paginate(sections[currentSection]).length;
      if (currentPageIndex + 2 < maxPages) {
        currentPageIndex += 2;
        renderPages();
      }
    });

    renderTabs();
    renderPages();
  </script>
</body>
</html>
